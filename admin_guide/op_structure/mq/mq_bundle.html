<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Message Queue Jobs and Transport Configuration &#8212; OroCommerce 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Message Queue Component in Oro Application" href="mq_component.html" />
    <link rel="prev" title="Message Queue" href="index.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
<div class="header">
    <div class="main-nav">
        <nav class="navbar navbar-default navbar-fixed-top">
            <div id="nav-menu" class="navbar-top">
                <div class="nav-container">
                    <div class="navbar-header">
                        <a href="https://www.orocommerce.com/"
                           class="navbar-brand"><img
                                src="https://www.orocommerce.com/wp-content/themes/commerce/images/orocommerce_logo.svg"
                                alt="Open Source B2B eCommerce Platform - OroCommerce"></a>
                    </div>
                    <div class="navbar-header">
                        <p class="navbar-header" href="#">Documentation</p>
                    </div>
                    <div class="navbar-right">
                        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mq_component.html" title="Message Queue Component in Oro Application"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Message Queue"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Administrator Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../index.html" >Operational Structure</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="index.html" accesskey="U">Message Queue</a> &#187;</li> 
     <li class="nav-item nav-item-this">Message Queue Jobs and Transport Configuration</li>
      </ul>
    </div>
                    </div>

                </div>
            </div>

        </nav>
    </div>
</div>


      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="message-queue-jobs-and-transport-configuration">
<span id="op-structure-mq"></span><h1>Message Queue Jobs and Transport Configuration<a class="headerlink" href="#message-queue-jobs-and-transport-configuration" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id4">Overview</a></li>
<li><a class="reference internal" href="#jobs" id="id5">Jobs</a></li>
<li><a class="reference internal" href="#usage" id="id6">Usage</a><ul>
<li><a class="reference internal" href="#dbal-transport" id="id7">DBAL Transport</a></li>
<li><a class="reference internal" href="#consumer-options" id="id8">Consumer Options</a></li>
<li><a class="reference internal" href="#consumer-interruption" id="id9">Consumer Interruption</a></li>
<li><a class="reference internal" href="#consumer-heartbeat" id="id10">Consumer Heartbeat</a></li>
<li><a class="reference internal" href="#supervisord" id="id11">Supervisord</a></li>
</ul>
</li>
<li><a class="reference internal" href="#internals" id="id12">Internals</a><ul>
<li><a class="reference internal" href="#structure" id="id13">Structure</a></li>
<li><a class="reference internal" href="#flow" id="id14">Flow</a></li>
<li><a class="reference internal" href="#custom-transport" id="id15">Custom Transport</a></li>
<li><a class="reference internal" href="#key-classes" id="id16">Key Classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unit-and-functional-tests" id="id17">Unit and Functional Tests</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id4">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The OroMessageQueue bundle integrates the OroMessageQueue component. It adds an easy to use
configuration layer, register services and ties them together, registers CLI commands.</p>
</div>
<div class="section" id="jobs">
<h2><a class="toc-backref" href="#id5">Jobs</a><a class="headerlink" href="#jobs" title="Permalink to this headline">¶</a></h2>
<p>The bundle provides an entity and a web gui for <a class="reference internal" href="mq_component.html#op-structure-mq-component-jobs"><span class="std std-ref">the jobs</span></a>. So the jobs are created in the db and have a web gui where you can monitor the jobs&#8217; status and interrupt jobs.</p>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id6">Usage</a><a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>First, you have to configure a transport layer and set one to be
default. For the config settings</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># app/config/config.yml

oro_message_queue:
    transport:
        default: &#39;%message_queue_transport%&#39;
        &#39;%message_queue_transport%&#39;: &#39;%message_queue_transport_config%&#39;
    client: ~
</pre></div>
</div>
<p>we can configure one of the supported transports via parameters:</p>
<div class="section" id="dbal-transport">
<h3><a class="toc-backref" href="#id7">DBAL Transport</a><a class="headerlink" href="#dbal-transport" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none"><div class="highlight"><pre><span></span># app/config/parameters.yml

    message_queue_transport: DBAL
    message_queue_transport_config: ~
</pre></div>
</div>
<p><a class="reference internal" href="dbal.html#op-structure-mq-mq-bundle-dbal"><span class="std std-ref">DBAL transport options</span></a></p>
<p>Once you configured everything you can start producing messages:</p>
<div class="code php highlight-php"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>

<span class="sd">/** @var Oro\Component\MessageQueue\Client\MessageProducer $messageProducer **/</span>
<span class="nv">$messageProducer</span> <span class="o">=</span> <span class="nv">$container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;oro_message_queue.message_producer&#39;</span><span class="p">);</span>

<span class="nv">$messageProducer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="s1">&#39;Something has happened&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>To consume messages you have to first create a message processor:</p>
<div class="code php highlight-php"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">use</span> <span class="nx">Oro\Component\MessageQueue\Consumption\MessageProcessor</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">FooMessageProcessor</span> <span class="k">implements</span> <span class="nx">MessageProcessor</span><span class="p">,</span> <span class="nx">TopicSubscriberInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">process</span><span class="p">(</span><span class="nx">Message</span> <span class="nv">$message</span><span class="p">,</span> <span class="nx">Session</span> <span class="nv">$session</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">echo</span> <span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">ACK</span><span class="p">;</span>
        <span class="c1">// return self::REJECT; // when the message is broken</span>
        <span class="c1">// return self::REQUEUE; // the message is fine but you want to postpone processing</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getSubscribedTopics</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Register it as a container service and subscribe to the topic:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>oro_channel.async.change_integration_status_processor:
    class: &#39;FooMessageProcessor&#39;
    tags:
        - { name: &#39;oro_message_queue.client.message_processor&#39; }
</pre></div>
</div>
<p>Now you can start consuming messages:</p>
<div class="code bash highlight-php"><div class="highlight"><pre><span></span><span class="o">./</span><span class="nx">app</span><span class="o">/</span><span class="nx">console</span> <span class="nx">oro</span><span class="o">:</span><span class="nx">message</span><span class="o">-</span><span class="nx">queue</span><span class="o">:</span><span class="nx">consume</span>
</pre></div>
</div>
<p><strong>*Note</strong>: Add -vvv to find out what is going while you are consuming
messages. There is a lot of valuable debug info there.*</p>
</div>
<div class="section" id="consumer-options">
<h3><a class="toc-backref" href="#id8">Consumer Options</a><a class="headerlink" href="#consumer-options" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">--message-limit=MESSAGE-LIMIT</span></code> Consume n messages and exit</li>
<li><code class="docutils literal"><span class="pre">--time-limit=TIME-LIMIT</span></code> Consume messages during this time</li>
<li><code class="docutils literal"><span class="pre">--memory-limit=MEMORY-LIMIT</span></code> Consume messages until process
reaches this memory limit in MB</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">--memory-limit</span></code> option is recommended for the normal consumer
usage. If the option is set a consumer checks the used memory amount
after each message processing and terminates if it is exceeded. For
example if a consumer was run:</p>
<div class="code bash highlight-php"><div class="highlight"><pre><span></span><span class="o">./</span><span class="nx">app</span><span class="o">/</span><span class="nx">console</span> <span class="nx">oro</span><span class="o">:</span><span class="nx">message</span><span class="o">-</span><span class="nx">queue</span><span class="o">:</span><span class="nx">consume</span> <span class="o">--</span><span class="nx">memory</span><span class="o">-</span><span class="nx">limit</span><span class="o">=</span><span class="mi">700</span>
</pre></div>
</div>
<p>then:</p>
<ul class="simple">
<li>The consumer processing a message</li>
<li>The consumer checks the used memory amount</li>
<li>If it exceeds the option value (i.e. 705 MB or 780Mb or 1300 Mb) the
consumer terminates (and Supervisord re-runs it)</li>
<li>Otherwise it continues message processing.</li>
</ul>
<p>We recommend to always set this option to the value 2-3 times less than
php memory limit. It will help to avoid php memory limit error during
message processing.</p>
<p>We recommend to set the <code class="docutils literal"><span class="pre">--time-limit</span></code> option to 5-10 minutes if using
the <code class="docutils literal"><span class="pre">DBAL</span></code> transport to avoid database connection issues</p>
</div>
<div class="section" id="consumer-interruption">
<h3><a class="toc-backref" href="#id9">Consumer Interruption</a><a class="headerlink" href="#consumer-interruption" title="Permalink to this headline">¶</a></h3>
<p>Consumers can normally interrupt the message procession by many reasons:</p>
<ul class="simple">
<li>Out of memory (if the option is set)</li>
<li>Timeout (if the option is set)</li>
<li>Messages limit exceeded (if the option is set)</li>
<li>Forcefully by an event:</li>
<li>If a cache was cleared</li>
<li>If a schema was updated</li>
<li>If a maintenance mode was turned off</li>
</ul>
<p>The normal interruption occurs only after a message was processed. If an
event was fired during a message processing a consumer completes the
message processing and interrupts after the processing is done.</p>
<p>Also a consumer interrupts <strong>if an exception was thrown during a message
processing</strong>.</p>
</div>
<div class="section" id="consumer-heartbeat">
<h3><a class="toc-backref" href="#id10">Consumer Heartbeat</a><a class="headerlink" href="#consumer-heartbeat" title="Permalink to this headline">¶</a></h3>
<p>Users may be informed about the state of consumers in the system (whether there is at least one alive). To guarantee that, the following process is used:</p>
<ul class="simple">
<li>On start and after every configured time period, each consumer calls the <cite>tick</cite> method of the ConsumerHeartbeat service that informs the system that the consumer is alive.</li>
<li>The cron command <cite>oro:cron:message-queue:consumer_heartbeat_check</cite> is periodically executed to check consumers&#8217; state. If it does not find any consumers alive, the <cite>oro/message_queue_state</cite> socket message is sent. This message notifies all logged-in users that the system may work incorrectly. Users of the management console get a flash message notification with information that consumers are not available.</li>
<li>The same check is also performed when a user logs in. This is done to notify users about the problem as soon as possible.</li>
</ul>
<p>The notification period can be changed in the application configuration file using the <cite>consumer_heartbeat_update_period</cite> option:</p>
<div class="code yaml highlight-php"><div class="highlight"><pre><span></span><span class="nx">oro_message_queue</span><span class="o">:</span>
    <span class="nx">consumer</span><span class="o">:</span>
        <span class="nx">heartbeat_update_period</span><span class="o">:</span> <span class="mi">20</span>  <span class="c1">#the update period was set to 20 minutes</span>
</pre></div>
</div>
<p>The default value of the <cite>heartbeat_update_period</cite> option is 15 minutes.</p>
<p>To disable the Consumer Heartbeat notifications, set the <cite>heartbeat_update_period</cite> option to 0.</p>
</div>
<div class="section" id="supervisord">
<h3><a class="toc-backref" href="#id11">Supervisord</a><a class="headerlink" href="#supervisord" title="Permalink to this headline">¶</a></h3>
<p>As you read before consumers can normally interrupt the message
procession by many reasons. In the all cases above the interrupted
consumer should be re-run. So you must keep running
<code class="docutils literal"><span class="pre">oro:message-queue:consume</span></code> command and to do this best we advise you
to delegate this responsibility to
<a class="reference external" href="http://supervisord.org/">Supervisord</a>. With next program
configuration supervisord keeps running four simultaneous instances of
<code class="docutils literal"><span class="pre">oro:message-queue:consume</span></code> command and cares about relaunch if
instance has dead by any reason.</p>
<div class="highlight-ini"><div class="highlight"><pre><span></span><span class="k">[program:oro_message_consumer]</span>
<span class="na">command</span><span class="o">=</span><span class="s">/path/to/app/console --env=prod --no-debug oro:message-queue:consume</span>
<span class="na">process_name</span><span class="o">=</span><span class="s">%(program_name)s_%(process_num)02d</span>
<span class="na">numprocs</span><span class="o">=</span><span class="s">4</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">startsecs</span><span class="o">=</span><span class="s">0</span>
<span class="na">user</span><span class="o">=</span><span class="s">apache</span>
<span class="na">redirect_stderr</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="internals">
<h2><a class="toc-backref" href="#id12">Internals</a><a class="headerlink" href="#internals" title="Permalink to this headline">¶</a></h2>
<div class="section" id="structure">
<h3><a class="toc-backref" href="#id13">Structure</a><a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h3>
<p>You can skip it if you are only going to use the component. The
component is split into several layers:</p>
<ul class="simple">
<li><strong>Transport</strong> - The transport API provides a common way for programs
to create, send, receive and read messages. Inspired by <a class="reference external" href="https://docs.oracle.com/javaee/1.4/api/javax/jms/package-summary.html">Java Message
Service</a></li>
<li><strong>Router</strong> - An implementation of <a class="reference external" href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/RecipientList.html">RecipientList</a> pattern.</li>
<li><strong>Consumption</strong> - the layer provides tools to simplify consumption of
messages. It provides a cli command, a queue consumer, message
processor and ways to extend it.</li>
<li><strong>Client</strong> - provides a high level abstraction. It provides easy to
use abstraction for producing and processing messages. It also
reduces a need to configure a broker.</li>
</ul>
<div class="figure" id="id1">
<img alt="The Oro MessageQueue component structure" src="../../../_images/component_structure_diagram.png" />
<p class="caption"><span class="caption-text">Component structure</span></p>
</div>
</div>
<div class="section" id="flow">
<h3><a class="toc-backref" href="#id14">Flow</a><a class="headerlink" href="#flow" title="Permalink to this headline">¶</a></h3>
<p>The client&#8217;s message producer sends a message to a router message
processor. It takes the message and search for real recipients who is
interested in such a message. Then, It sends a copy of a message for all
of them. Each target message processor takes its copy of the message and
process it.</p>
<div class="figure" id="id2">
<img alt="The message flow" src="../../../_images/message_flow_diagram.png" />
<p class="caption"><span class="caption-text">Message flow</span></p>
</div>
<p>The message itself has headers and body and they change this way while
traveling through the system:</p>
<div class="figure" id="id3">
<img alt="The message structure" src="../../../_images/message_structure_diagram.png" />
<p class="caption"><span class="caption-text">Message structure</span></p>
</div>
</div>
<div class="section" id="custom-transport">
<h3><a class="toc-backref" href="#id15">Custom Transport</a><a class="headerlink" href="#custom-transport" title="Permalink to this headline">¶</a></h3>
<p>If you happen to need to implement a custom provider take a look at
transport&#8217;s interfaces. You have to provide an implementation for them</p>
</div>
<div class="section" id="key-classes">
<h3><a class="toc-backref" href="#id16">Key Classes</a><a class="headerlink" href="#key-classes" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Component/MessageQueue/Client/MessageProducer.php">MessageProducer</a> - The client&#8217;s message producer, you will use it
all the time to send messages</li>
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Component/MessageQueue/Consumption/MessageProcessorInterface.php">MessageProcessorInterface</a> - Each class which does the job has to
implement this interface</li>
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Component/MessageQueue/Client/TopicSubscriberInterface.php">TopicSubscriberInterface</a> - Kind of EventSubscriberInterface. It
allows you to keep a processing code and topics it is subscribed to
in one place.</li>
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Component/MessageQueue/Client/ConsumeMessagesCommand.php">MessageConsumeCommand</a> - A command you use to consume messages.</li>
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Component/MessageQueue/Consumption/QueueConsumer.php">QueueConsumer</a> - A class that works inside the command and watch
for a new message and once it is get it pass it to a message
processor.</li>
</ul>
</div>
</div>
<div class="section" id="unit-and-functional-tests">
<h2><a class="toc-backref" href="#id17">Unit and Functional Tests</a><a class="headerlink" href="#unit-and-functional-tests" title="Permalink to this headline">¶</a></h2>
<p>To test that a message was sent in unit and functional tests, you can
use <code class="docutils literal"><span class="pre">MessageQueueExtension</span></code> trait. There are two implementation of
this trait, one for unit tests, another for functional tests:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Bundle/MessageQueueBundle/Test/Unit/MessageQueueExtension.php">OroBundleMessageQueueBundleTestUnitMessageQueueExtension</a>
for unit tests</li>
<li><a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Bundle/MessageQueueBundle/Test/Functional/MessageQueueExtension.php">OroBundleMessageQueueBundleTestFunctionalMessageQueueExtension</a>
for functional tests</li>
</ul>
<p>Also, in case if you need custom logic for manage sent messages, you can
use
<a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Bundle/MessageQueueBundle/Test/Unit/MessageQueueAssertTrait.php">OroBundleMessageQueueBundleTestUnitMessageQueueAssertTrait</a>
or
<a class="reference external" href="https://github.com/oroinc/platform/blob/master/src/Oro/Bundle/MessageQueueBundle/Test/Functional/MessageProcessTrait.php">OroBundleMessageQueueBundleTestFunctionalMessageQueueAssertTrait</a>
traits.</p>
<p>Before you start to use traits in functional tests, you need to register
<code class="docutils literal"><span class="pre">oro_message_queue.test.message_collector</span></code> service for <code class="docutils literal"><span class="pre">test</span></code>
environment.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># app/config/config_test.yml

services:
    oro_message_queue.test.message_collector:
        class: Oro\Bundle\MessageQueueBundle\Test\Functional\MessageCollector
        decorates: oro_message_queue.client.message_producer
        arguments:
            - &#39;@oro_message_queue.test.message_collector.inner&#39;
</pre></div>
</div>
<p>The following example shows how to test whether a message was sent.</p>
<div class="code php highlight-php"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">Acme\Bundle\AcmeBundle\Tests\Functional</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Oro\Bundle\MessageQueueBundle\Test\Functional\MessageQueueExtension</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Oro\Bundle\TestFrameworkBundle\Test\WebTestCase</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeTest</span> <span class="k">extends</span> <span class="nx">WebTestCase</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">MessageQueueExtension</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSingleMessage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// assert that a message was sent to a topic</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessageSent</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="s1">&#39;Something has happened&#39;</span><span class="p">);</span>

        <span class="c1">// assert that at least one message was sent to a topic</span>
        <span class="c1">// can be used if a message is not matter</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessageSent</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSeveralMessages</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// assert that exactly given messages were sent to a topic</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessagesSent</span><span class="p">(</span>
            <span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">&#39;Something has happened&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Something else has happened&#39;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">);</span>
        <span class="c1">// assert that the exactly given number of messages were sent to a topic</span>
        <span class="c1">// can be used if messages are not matter</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessagesCount</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="c1">// also assertCountMessages alias can be used to do the same assertion</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertCountMessages</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testNoMessages</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// assert that no any message was sent to a topic</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessagesEmpty</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">);</span>
        <span class="c1">// also assertEmptyMessages alias can be used to do the same assertion</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertEmptyMessages</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testAllMessages</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// assert that exactly given messages were sent</span>
        <span class="c1">// NOTE: use this assertion with caution because it is possible</span>
        <span class="c1">// that messages not related to a testing functionality were sent as well</span>
        <span class="nx">self</span><span class="o">::</span><span class="na">assertAllMessagesSent</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="s1">&#39;topic&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Something has happened&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="s1">&#39;topic&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Something else has happened&#39;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In unit tests you are usually need to pass the message producer to a
service you test. To fetch correct instance of message producer in the
unit tests use <code class="docutils literal"><span class="pre">self::getMessageProducer()</span></code>, e.g.:</p>
<div class="code php highlight-php"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="k">namespace</span> <span class="nx">Acme\Bundle\AcmeBundle\Tests\Unit</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Acme\Bundle\AcmeBundle\SomeClass</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Oro\Bundle\MessageQueueBundle\Test\Unit\MessageQueueExtension</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SomeTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">MessageQueueExtension</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testSingleMessage</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SomeClass</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">getMessageProducer</span><span class="p">());</span>

        <span class="nv">$instance</span><span class="o">-&gt;</span><span class="na">doSomethind</span><span class="p">();</span>

        <span class="nx">self</span><span class="o">::</span><span class="na">assertMessageSent</span><span class="p">(</span><span class="s1">&#39;aFooTopic&#39;</span><span class="p">,</span> <span class="s1">&#39;Something has happened&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../install_upgrade/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../seo_config_guide/index.html">SEO Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../frontstore_guide/index.html">Front Store Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev_guide/index.html">Developer Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Administrator Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Operational Structure</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../search_index/index.html">Search Index</a></li>
<li class="toctree-l3"><a class="reference internal" href="../database/index.html">DataBase System Component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cache.html">Cache in Oro Application</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Message Queue</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../optimize_server_compression_and_caching.html">Web Server Performance Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../price_list_sharding.html">How to Configure Price List Sharding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../optimize_index_and_price_calculation.html">Optimize Website Indexation and Price Recalculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../package_manager.html">Extensions and Package Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processes.html">Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../jobs.html">Job Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cron.html">Scheduled Tasks via Cron</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../monitoring/index.html">Healthcheck and Data Monitoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration_guide/index.html">Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/index.html">Community Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../system_requirements.html">System Requirements</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Oro Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../../../_sources/admin_guide/op_structure/mq/mq_bundle.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>