<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to Add Entity Event Listeners &#8212; OroCommerce 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to Create and Customize Application Menu" href="how_to_create_and_customize_application_menu.html" />
    <link rel="prev" title="How to Extend Existing Bundle" href="how_to_extend_existing_bundle.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-to-add-entity-event-listeners">
<span id="index-0"></span><h1>How to Add Entity Event Listeners<a class="headerlink" href="#how-to-add-entity-event-listeners" title="Permalink to this headline">¶</a></h1>
<p><em>Used application: OroPlatform 1.7</em></p>
<p>In some cases, you need to update a field before saving or before updating an entity.
A Doctrine Listener is a perfect way to do that.</p>
<div class="section" id="configuring-the-listener">
<h2>Configuring the Listener<a class="headerlink" href="#configuring-the-listener" title="Permalink to this headline">¶</a></h2>
<p>Suppose that you have already extended an Oro bundle like <code class="docutils literal"><span class="pre">OroContactBundle</span></code> (you can find more information
on this page: <a class="reference internal" href="how_to_extend_existing_bundle.html#how-to-extend-existing-bundle"><span class="std std-ref">How to extend existing bundle</span></a>).
And you would like to compliment your contact&#8217;s social information with some external API data.</p>
<p>For this you need to register your listener in the <code class="docutils literal"><span class="pre">services.yml</span></code> file.</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># src/Acme/Bundle/ContactBundle/Resources/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">contact.listener</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Acme\Bundle\ContactBundle\Listener\SocialFields</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">name</span><span class="p p-Indicator">:</span> <span class="nv">doctrine.event_listener</span><span class="p p-Indicator">,</span> <span class="nv">event</span><span class="p p-Indicator">:</span> <span class="nv">onFlush</span> <span class="p p-Indicator">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="creating-the-listener-class">
<h2>Creating the Listener Class<a class="headerlink" href="#creating-the-listener-class" title="Permalink to this headline">¶</a></h2>
<p>In the previous part, we created the contact.listener that is triggered during the flush of en entity.
In fact, the event will be triggered when all managed entities are being flushed, so you need to check the current
entity class type.</p>
<p>This class must have the <code class="docutils literal"><span class="pre">onFlush</span></code> method, which will be called when the event is dispatched:</p>
<div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="c1">// src/Acme/Bundle/ContactBundle/Listener/SocialFields.php</span>
<span class="k">namespace</span> <span class="nx">Acme\Bundle\ContactBundle\Listener</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Event\OnFlushEventArgs</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Oro\Bundle\ContactBundle\Entity\ContactEmail</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SocialFields</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onFlush</span><span class="p">(</span><span class="nx">OnFlushEventArgs</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$em</span> <span class="o">=</span> <span class="nv">$args</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>
        <span class="nv">$uow</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getUnitOfWork</span><span class="p">();</span>

        <span class="c1">// we would like to listen on insertions and updates events</span>
        <span class="nv">$entities</span> <span class="o">=</span> <span class="nb">array_merge</span><span class="p">(</span>
            <span class="nv">$uow</span><span class="o">-&gt;</span><span class="na">getScheduledEntityInsertions</span><span class="p">(),</span>
            <span class="nv">$uow</span><span class="o">-&gt;</span><span class="na">getScheduledEntityUpdates</span><span class="p">()</span>
        <span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$entities</span> <span class="k">as</span> <span class="nv">$entity</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// every time we update or insert a new ContactEmail entity we do the work</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$entity</span> <span class="nx">instanceof</span> <span class="nx">ContactEmail</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// check if email is primary</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">isPrimary</span><span class="p">())</span> <span class="p">{</span>
                <span class="nv">$owner</span> <span class="o">=</span> <span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">getOwner</span><span class="p">();</span>

                <span class="c1">// ... update social info of the owner with its primary email</span>

                <span class="c1">// force persist</span>
                <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$owner</span><span class="p">);</span>
                <span class="nv">$md</span> <span class="o">=</span> <span class="nv">$em</span><span class="o">-&gt;</span><span class="na">getClassMetadata</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$owner</span><span class="p">));</span>
                <span class="nv">$uow</span><span class="o">-&gt;</span><span class="na">computeChangeSet</span><span class="p">(</span><span class="nv">$md</span><span class="p">,</span> <span class="nv">$owner</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition caution">
<p class="first admonition-title">Caution</p>
<p class="last">In case of update, we need to persist the related entities and force update
them with <code class="docutils literal"><span class="pre">computeChangeSet()</span></code> function. Every entity related to the current
one must be updated like this if you change any property values. If you
do not, the new value of your related entity&#8217;s property will not be updated.</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://symfony.com/doc/current/cookbook/doctrine/event_listeners_subscribers.html">Symfony Cookbook How to Register Event Listeners and Subscribers</a></li>
<li><a class="reference external" href="http://doctrine-orm.readthedocs.org/en/latest/reference/events.html">Doctrine Events</a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Table Of Contents</a></h3>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/dev_guide/extend_and_customize/how_to_add_entity_event_listeners.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Developer Guide</a><ul>
  <li><a href="index.html">Customizing Oro Features</a><ul>
      <li>Previous: <a href="how_to_extend_existing_bundle.html" title="previous chapter">How to Extend Existing Bundle</a></li>
      <li>Next: <a href="how_to_create_and_customize_application_menu.html" title="next chapter">How to Create and Customize Application Menu</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Oro Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
      |
      <a href="../../_sources/dev_guide/extend_and_customize/how_to_add_entity_event_listeners.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>